<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>体調管理アプリ (モバイル最適化)</title>
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--muted:#6b7280;--accent:#2563eb}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,Arial;margin:0;background:var(--bg);color:#111;line-height:1.5}
    .container{max-width:680px;margin:0 auto;padding:12px}
    header{display:flex;flex-direction:column;align-items:flex-start;gap:6px;margin-bottom:10px}
    h1{font-size:1.2rem;margin:0}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 4px 10px rgba(16,24,40,0.06);margin-bottom:14px}
    form{display:flex;flex-direction:column;gap:10px}
    label{font-size:13px;color:var(--muted);margin-bottom:2px;display:block}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:15px}
    textarea{min-height:70px;resize:vertical}
    .actions{display:flex;flex-wrap:wrap;gap:8px}
    button{flex:1;background:var(--accent);color:#fff;border:none;padding:12px;border-radius:10px;cursor:pointer;font-size:15px}
    button.secondary{background:#efefef;color:#111}
    .list{margin-top:10px}
    .entry{display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:10px;border:1px solid #f0f2f5;background:#fff;margin-bottom:10px}
    .entry strong{font-size:15px}
    .meta{font-size:13px;color:var(--muted)}
    .pill{display:inline-block;padding:5px 9px;border-radius:999px;font-size:12px;background:#f3f4f6;margin-right:5px;margin-top:3px}
    .controls{display:flex;gap:6px}
    .controls button{flex:1;padding:8px;font-size:13px}
    .chart-wrap{margin-top:12px}
    canvas{max-width:100%}
    footer{margin-top:14px;color:var(--muted);font-size:12px;text-align:center;padding-bottom:20px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>体調管理アプリ（モバイル最適化）</h1>
      <div class="meta">ローカル保存・エクスポート対応</div>
    </header>

    <section class="card">
      <h2 style="margin:0 0 8px 0;font-size:1rem">新しい記録を追加</h2>
      <form id="entryForm">
        <div>
          <label for="date">日付</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label for="mood">気分 (1-5)</label>
          <select id="mood" required>
            <option value="5">5 — とても良い</option>
            <option value="4">4 — 良い</option>
            <option value="3">3 — 普通</option>
            <option value="2">2 — 少し悪い</option>
            <option value="1">1 — とても悪い</option>
          </select>
        </div>
        <div>
          <label for="sleep">睡眠時間（時間）</label>
          <input type="number" step="0.1" id="sleep" min="0" max="24" />
        </div>
        <div>
          <label for="temp">体温（℃）</label>
          <input type="number" step="0.1" id="temp" min="30" max="45" />
        </div>
        <div>
          <label for="symptoms">症状 / 備考</label>
          <textarea id="symptoms" placeholder="頭痛、のどの痛み、薬を飲んだなど"></textarea>
        </div>
        <div class="actions">
          <button type="submit">保存</button>
          <button type="button" id="clearForm" class="secondary">クリア</button>
        </div>
        <div class="actions">
          <button type="button" id="exportJson" class="secondary">JSON出力</button>
          <button type="button" id="exportCsv" class="secondary">CSV出力</button>
          <label class="secondary" style="flex:1;text-align:center;padding:12px;border-radius:10px">
            インポート<input type="file" id="importFile" accept="application/json,text/csv" style="display:none" />
          </label>
          <button type="button" id="clearAll" class="secondary">全削除</button>
        </div>
      </form>
    </section>

    <section class="card list">
      <h2 style="margin:0 0 8px 0;font-size:1rem">記録一覧</h2>
      <div id="entries"></div>
      <div id="noEntries" class="meta" style="display:none">まだ記録がありません。</div>

      <div class="chart-wrap card">
        <h3 style="margin:0 0 8px 0;font-size:0.95rem">推移グラフ（気分・体温）</h3>
        <canvas id="trendChart" height="200"></canvas>
      </div>
    </section>

    <footer>
      このファイルを VSCode で保存して開くと、スマホでも体調データを管理できます。
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const KEY='healthTrackerEntries_v1';
    const qs=s=>document.querySelector(s);
    const qsa=s=>Array.from(document.querySelectorAll(s));
    const form=qs('#entryForm');
    const entriesWrap=qs('#entries');
    const noEntries=qs('#noEntries');
    const exportJsonBtn=qs('#exportJson');
    const exportCsvBtn=qs('#exportCsv');
    const importFile=qs('#importFile');
    const clearAllBtn=qs('#clearAll');
    const clearFormBtn=qs('#clearForm');
    let chart=null;

    function loadEntries(){try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):[]}catch(e){return[]}}
    function saveEntries(arr){localStorage.setItem(KEY,JSON.stringify(arr));renderEntries()}
    function addEntry(e){const arr=loadEntries();arr.push(e);arr.sort((a,b)=>new Date(a.date)-new Date(b.date));saveEntries(arr)}
    function updateEntry(id,u){const arr=loadEntries();const i=arr.findIndex(e=>e.id===id);if(i>=0){arr[i]=u;saveEntries(arr)}}
    function deleteEntry(id){let arr=loadEntries();arr=arr.filter(e=>e.id!==id);saveEntries(arr)}

    function renderEntries(){const arr=loadEntries();entriesWrap.innerHTML='';if(arr.length===0){noEntries.style.display='block';if(chart)updateChart([]);return}noEntries.style.display='none';arr.slice().reverse().forEach(e=>{const div=document.createElement('div');div.className='entry';div.innerHTML=`<strong>${e.date}</strong><div>${e.mood?`<span class="pill">気分:${e.mood}</span>`:''}${e.temp?`<span class="pill">体温:${e.temp}℃</span>`:''}${e.sleep?`<span class="pill">睡眠:${e.sleep}h</span>`:''}</div><div class="meta">${e.symptoms||''}</div><div class="controls"><button data-action="edit" data-id="${e.id}">編集</button><button data-action="delete" data-id="${e.id}">削除</button></div>`;entriesWrap.appendChild(div)});attachButtons();updateChart(arr)}

    function attachButtons(){qsa('[data-action="edit"]').forEach(b=>b.onclick=()=>{const id=b.dataset.id;const e=loadEntries().find(x=>x.id===id);if(!e)return;qs('#date').value=e.date;qs('#mood').value=e.mood;qs('#sleep').value=e.sleep||'';qs('#temp').value=e.temp||'';qs('#symptoms').value=e.symptoms||'';form.dataset.editing=id});qsa('[data-action="delete"]').forEach(b=>b.onclick=()=>{if(confirm('削除しますか？'))deleteEntry(b.dataset.id)})}

    function initChart(){chart=new Chart(qs('#trendChart'),{type:'line',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:false}}}})}
    function updateChart(arr){if(!chart)return;const sorted=arr.slice().sort((a,b)=>new Date(a.date)-new Date(b.date));const labels=sorted.map(x=>x.date);const mood=sorted.map(x=>Number(x.mood));const temp=sorted.map(x=>x.temp?Number(x.temp):null);chart.data.labels=labels;chart.data.datasets=[{label:'気分(1-5)',data:mood,tension:0.2,yAxisID:'y'},{label:'体温(℃)',data:temp,tension:0.2,yAxisID:'y1'}];chart.options.scales={y:{type:'linear',position:'left',min:1,max:5,ticks:{stepSize:1}},y1:{type:'linear',position:'right',grid:{drawOnChartArea:false}}};chart.update()}

    function download(fn,c){const blob=new Blob([c],{type:'application/octet-stream'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=fn;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}
    function toCsv(arr){const h=['id','date','mood','sleep','temp','symptoms'];const lines=[h.join(',')];arr.forEach(r=>{const row=[r.id,r.date,r.mood,r.sleep??'',r.temp??'',`"${(r.symptoms||'').replace(/"/g,'""')}"`];lines.push(row.join(','))});return lines.join('\n')}

    form.onsubmit=e=>{e.preventDefault();const id=form.dataset.editing||crypto.randomUUID();const entry={id,date:qs('#date').value,mood:qs('#mood').value,sleep:qs('#sleep').value?Number(qs('#sleep').value):null,temp:qs('#temp').value?Number(qs('#temp').value):null,symptoms:qs('#symptoms').value};if(form.dataset.editing){updateEntry(id,entry);delete form.dataset.editing}else addEntry(entry);form.reset()}
    clearFormBtn.onclick=()=>form.reset()
    exportJsonBtn.onclick=()=>download('health_entries.json',JSON.stringify(loadEntries(),null,2))
    exportCsvBtn.onclick=()=>download('health_entries.csv',toCsv(loadEntries()))
    importFile.onchange=async e=>{const f=e.target.files[0];if(!f)return;const t=await f.text();try{if(f.name.endsWith('.csv')){const lines=t.split(/\r?\n/).filter(Boolean);lines.shift();const arr=lines.map(l=>{const [id,date,mood,sleep,temp,symptoms]=l.split(',');return{id:id||crypto.randomUUID(),date,mood,sleep:sleep?Number(sleep):null,temp:temp?Number(temp):null,symptoms:symptoms?.replace(/^"|"$/g,'')}});saveEntries(arr)}else{const arr=JSON.parse(t);if(Array.isArray(arr))saveEntries(arr)}}catch(err){alert('インポート失敗:'+err.message)}importFile.value=''}
    clearAllBtn.onclick=()=>{if(confirm('全データを削除しますか？')){localStorage.removeItem(KEY);renderEntries()}}

    initChart();renderEntries();
  </script>
</body>
</html>
